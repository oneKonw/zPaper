<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>方案对比功能</title>
  <style>
    html,
    body {
      padding: 0;
      margin: 0;
      height: 100%;
    }

    .map-container {
      height: 100%;
      display: flex;
    }

    #view1Div {
      height: 100%;
      flex: auto;
      border: 2px #285c95 solid;
      padding: 5px;
    }

    #view2Div {
      height: 100%;
      flex: auto;
      border: 2px #285c95 solid;
      padding: 5px;
    }
  </style>
  <script src="./libs/jquery-1.11.1.min.js"></script>
  <script src="./libs/jquery-ui-1.12.1.js"></script>

  <link rel="stylesheet" href="http://nanping.arcgisonline.cn/jsapi/4.7/esri/css/main.css">
  <script src="./config/config.js"></script>
  <script src="http://nanping.arcgisonline.cn/jsapi/4.7/init.js"></script>


  <script>
    require([
      "esri/tasks/Locator",
      "dojo/_base/declare", "esri/config",
      "esri/Map",
      "esri/WebScene",
      'esri/WebMap',
      "esri/views/MapView",
      "esri/views/SceneView",
      "esri/layers/GraphicsLayer",
      "esri/Graphic",
      "esri/layers/FeatureLayer",
      "esri/core/watchUtils",
      'esri/widgets/LayerList',
      "dojo/dom-construct", "dojo/dom-style", "dojo/dom-class",
      "dojo/dom", "dojo/on", "dojo/_base/lang",
      "dojo/domReady!",
    ], function (Locator, declare, esriConfig, Map, WebScene, WebMap, MapView, SceneView, GraphicsLayer, Graphic, FeatureLayer, watchUtils, LayerList, domConstruct, domStyle, domClass,
      dom, on, lang, ) {

        esriConfig.portalUrl = window.appcfg.portal
        esriConfig.request.proxyUrl = window.appcfg.proxy

        var map1 = new WebMap({
          // autocasts as esri/portal/PortalItem
          portalItem: {
            id: window.appcfg.splitItemIdone  // 修改左边图层的portalId
          }
        });
        var view1 = new MapView({
          id: 'view1',
          map: map1,
          container: 'view1Div',
        })



        var map2 = new WebMap({
          // autocasts as esri/portal/PortalItem
          portalItem: {
            id: window.appcfg.splitItemIdtwo  // 修改右边边图层的portalId
          }
        });
        var view2 = new MapView({
          id: 'view2',
          map: map2,
          container: 'view2Div',
          // constraints: {
          //   // Disable zoom snapping to get the best synchonization
          //   snapToZoom: false
          // }
        })
        var leftLayerList = new LayerList({
          view: view1
        });
        view1.ui.add(leftLayerList, {
          position: "top-right"
        });

        var rightLayerList = new LayerList({
          view: view2
        });

        view2.ui.add(rightLayerList, {
          position: "top-right"
        });


        //同步两个地图的方法——————————————————————————————————————————————————————————————————————————————————————————————————————————————————
        var synchronizeView = function (view, others) {
          others = Array.isArray(others) ? others : [others];

          var viewpointWatchHandle;
          var viewStationaryHandle;
          var otherInteractHandlers;
          var scheduleId;

          var clear = function () {
            if (otherInteractHandlers) {
              otherInteractHandlers.forEach(function (handle) {
                handle.remove();
              });
            }
            viewpointWatchHandle && viewpointWatchHandle.remove();
            viewStationaryHandle && viewStationaryHandle.remove();
            scheduleId && clearTimeout(scheduleId);
            otherInteractHandlers = viewpointWatchHandle =
              viewStationaryHandle = scheduleId = null;
          };

          var interactWatcher = view.watch('interacting,animation',
            function (newValue) {
              if (!newValue) {
                return;
              }
              if (viewpointWatchHandle || scheduleId) {
                return;
              }

              // start updating the other views at the next frame
              scheduleId = setTimeout(function () {
                scheduleId = null;
                viewpointWatchHandle = view.watch('viewpoint',
                  function (newValue) {
                    others.forEach(function (otherView) {
                      otherView.viewpoint = newValue;
                    });
                  });
              }, 0);

              // stop as soon as another view starts interacting, like if the user starts panning
              otherInteractHandlers = others.map(function (otherView) {
                return watchUtils.watch(otherView,
                  'interacting,animation',
                  function (
                    value) {
                    if (value) {
                      clear();
                    }
                  });
              });

              // or stop when the view is stationary again
              viewStationaryHandle = watchUtils.whenTrue(view,
                'stationary', clear);
            });

          return {
            remove: function () {
              this.remove = function () { };
              clear();
              interactWatcher.remove();
            }
          }
        };
        var synchronizeViews = function (views) {
          var handles = views.map(function (view, idx, views) {
            var others = views.concat();
            others.splice(idx, 1);
            return synchronizeView(view, others);
          });

          return {
            remove: function () {
              this.remove = function () { };
              handles.forEach(function (h) {
                h.remove();
              });
              handles = null;
            }
          }
        }
        //同步两个地图的方法到此为止——————————————————————————————————————————————————————————————————————————————————————————————————————————————
        synchronizeViews([view1, view2]);

      });
  </script>
</head>

<body>
  <div class="map-container">
    <div id="view1Div"></div>
    <div id="view2Div"></div>
  </div>
</body>

</html>